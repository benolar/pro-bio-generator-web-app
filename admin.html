<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | BioGen</title>
    <link href="./output.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #3f3f46; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-[#0b0c0d] text-gray-800 dark:text-gray-200 h-screen overflow-hidden flex transition-colors duration-300">

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay" class="fixed inset-0 z-50 bg-gray-50 dark:bg-[#0b0c0d] flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md bg-white dark:bg-[#1e1f20] rounded-2xl shadow-xl border border-gray-200 dark:border-gray-800 p-8 text-center">
            <div class="w-16 h-16 bg-indigo-100 dark:bg-indigo-900/30 rounded-2xl flex items-center justify-center mx-auto mb-6 text-2xl">⚡</div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Admin Portal</h1>
            <p class="text-gray-500 dark:text-gray-400 mb-8">Restricted access area. Please verify your identity.</p>
            
            <button id="admin-login-btn" class="w-full bg-gray-900 dark:bg-white text-white dark:text-gray-900 font-bold py-3.5 rounded-xl hover:shadow-lg transition-all flex items-center justify-center gap-2 mb-4">
                <svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.21H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                Sign in with Google
            </button>
            <div id="login-error" class="text-red-500 text-sm hidden">Access Denied. Email not authorized.</div>
        </div>
    </div>

    <!-- SIDEBAR -->
    <aside class="w-64 bg-white dark:bg-[#1e1f20] border-r border-gray-200 dark:border-gray-800 flex-col hidden md:flex">
        <div class="p-6 flex items-center gap-2 border-b border-gray-100 dark:border-gray-800">
            <span class="text-indigo-600 dark:text-indigo-400 text-xl">⚡</span>
            <span class="font-bold text-gray-900 dark:text-white text-lg tracking-tight">BioGen Admin</span>
        </div>
        
        <nav class="flex-1 p-4 space-y-1">
            <button data-tab="dashboard" class="nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-medium transition-colors bg-indigo-50 dark:bg-indigo-900/20 text-indigo-700 dark:text-indigo-300">
                Dashboard
            </button>
            <button data-tab="users" class="nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-medium text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-[#2c2d2e] transition-colors">
                Users Management
            </button>
            <button data-tab="bios" class="nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-medium text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-[#2c2d2e] transition-colors">
                Global Bios
            </button>
        </nav>

        <div class="p-4 border-t border-gray-200 dark:border-gray-800">
            <div class="flex items-center gap-3 mb-4 px-2">
                <div class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 overflow-hidden" id="admin-avatar"></div>
                <div class="flex-1 min-w-0">
                    <div class="text-xs font-bold text-gray-900 dark:text-white truncate" id="admin-name">Admin</div>
                    <div class="text-[10px] text-gray-500 truncate" id="admin-email">...</div>
                </div>
            </div>
            <button id="logout-btn" class="w-full text-xs font-bold text-red-500 hover:bg-red-50 dark:hover:bg-red-900/10 py-2 rounded-lg transition-colors">Log Out</button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col min-w-0 bg-gray-50 dark:bg-[#0b0c0d] relative overflow-hidden">
        <!-- Mobile Header -->
        <header class="md:hidden bg-white dark:bg-[#1e1f20] p-4 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center">
            <span class="font-bold text-gray-900 dark:text-white">Admin</span>
            <button id="mobile-menu-btn" class="text-gray-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
        </header>

        <div class="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-8" id="content-area">
            
            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="space-y-6">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Overview</h2>
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white dark:bg-[#1e1f20] p-6 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm relative overflow-hidden group">
                        <div class="absolute right-0 top-0 w-24 h-24 bg-indigo-50 dark:bg-indigo-900/10 rounded-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                        <div class="relative">
                            <div class="text-gray-500 dark:text-gray-400 text-sm font-medium mb-1">Total Users</div>
                            <div class="text-3xl font-bold text-gray-900 dark:text-white" id="stat-users">-</div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-[#1e1f20] p-6 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm relative overflow-hidden group">
                        <div class="absolute right-0 top-0 w-24 h-24 bg-amber-50 dark:bg-amber-900/10 rounded-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                        <div class="relative">
                            <div class="text-gray-500 dark:text-gray-400 text-sm font-medium mb-1">Pro Subscribers</div>
                            <div class="text-3xl font-bold text-gray-900 dark:text-white" id="stat-pro">-</div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-[#1e1f20] p-6 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm relative overflow-hidden group">
                        <div class="absolute right-0 top-0 w-24 h-24 bg-emerald-50 dark:bg-emerald-900/10 rounded-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                        <div class="relative">
                            <div class="text-gray-500 dark:text-gray-400 text-sm font-medium mb-1">Bios Generated</div>
                            <div class="text-3xl font-bold text-gray-900 dark:text-white" id="stat-bios">-</div>
                        </div>
                    </div>
                </div>

                <!-- Recent Logs -->
                <div class="bg-white dark:bg-[#1e1f20] rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center">
                        <h3 class="font-bold text-gray-900 dark:text-white">System Alerts / Webhook Logs</h3>
                        <button id="refresh-logs" class="text-xs bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 px-2 py-1 rounded transition-colors">Refresh</button>
                    </div>
                    <div id="logs-list" class="divide-y divide-gray-100 dark:divide-gray-800 max-h-80 overflow-y-auto">
                        <div class="p-4 text-center text-sm text-gray-500">Loading logs...</div>
                    </div>
                </div>
            </div>

            <!-- VIEW: USERS -->
            <div id="view-users" class="space-y-6 hidden">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">User Management</h2>
                    <button id="refresh-users" class="bg-white dark:bg-[#1e1f20] border border-gray-200 dark:border-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-[#2c2d2e] transition-colors">Refresh</button>
                </div>
                <div class="bg-white dark:bg-[#1e1f20] rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 dark:bg-[#252627] text-gray-500 dark:text-gray-400 font-medium border-b border-gray-200 dark:border-gray-800">
                                <tr>
                                    <th class="px-6 py-3">User</th>
                                    <th class="px-6 py-3">Status</th>
                                    <th class="px-6 py-3">UID</th>
                                    <th class="px-6 py-3">Last Active</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body" class="divide-y divide-gray-100 dark:divide-gray-800 text-gray-700 dark:text-gray-300">
                                <tr><td colspan="4" class="p-6 text-center">Loading users...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: BIOS -->
            <div id="view-bios" class="space-y-6 hidden">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Recent Generations</h2>
                    <button id="refresh-bios" class="bg-white dark:bg-[#1e1f20] border border-gray-200 dark:border-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-[#2c2d2e] transition-colors">Refresh</button>
                </div>
                <div id="bios-feed" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div class="p-10 text-center text-gray-500 col-span-2">Loading recent bios...</div>
                </div>
            </div>

        </div>
    </main>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAqqENNvQzrUdMFcjEJsG2iygrQWNWS0A",
            authDomain: "pro-tools-web-app.firebaseapp.com",
            projectId: "pro-tools-web-app",
            storageBucket: "pro-tools-web-app.firebasestorage.app",
            messagingSenderId: "146517824837",
            appId: "1:146517824837:web:12d1c042f8493b1bab1a2c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        // UI Refs
        const loginOverlay = document.getElementById('login-overlay');
        const loginBtn = document.getElementById('admin-login-btn');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const adminName = document.getElementById('admin-name');
        const adminEmail = document.getElementById('admin-email');
        const adminAvatar = document.getElementById('admin-avatar');
        
        const navBtns = document.querySelectorAll('.nav-btn');
        const views = {
            dashboard: document.getElementById('view-dashboard'),
            users: document.getElementById('view-users'),
            bios: document.getElementById('view-bios')
        };

        // Auth Logic
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Verify Admin via Backend API
                try {
                    const token = await user.getIdToken();
                    const res = await fetch('/api/admin', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ action: 'checkAuth' })
                    });
                    
                    if (res.ok) {
                        loginOverlay.classList.add('hidden');
                        adminName.textContent = user.displayName || 'Admin';
                        adminEmail.textContent = user.email;
                        if(user.photoURL) adminAvatar.innerHTML = `<img src="${user.photoURL}" class="w-full h-full object-cover">`;
                        
                        loadDashboard();
                    } else {
                        throw new Error("Unauthorized");
                    }
                } catch (e) {
                    console.error(e);
                    loginError.classList.remove('hidden');
                    loginError.textContent = "Unauthorized: Your email is not an admin.";
                    setTimeout(() => signOut(auth), 2000);
                }
            } else {
                loginOverlay.classList.remove('hidden');
                loginError.classList.add('hidden');
            }
        });

        loginBtn.onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        logoutBtn.onclick = () => signOut(auth);

        // Navigation Logic
        navBtns.forEach(btn => {
            btn.onclick = () => {
                // Update Active State
                navBtns.forEach(b => b.className = "nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-medium text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-[#2c2d2e] transition-colors");
                btn.className = "nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-medium transition-colors bg-indigo-50 dark:bg-indigo-900/20 text-indigo-700 dark:text-indigo-300";
                
                // Show View
                const tab = btn.dataset.tab;
                Object.values(views).forEach(v => v.classList.add('hidden'));
                views[tab].classList.remove('hidden');
                
                // Load Data
                if(tab === 'users') loadUsers();
                if(tab === 'bios') loadBios();
                if(tab === 'dashboard') loadDashboard();
            };
        });

        // Data Fetching Wrapper
        async function apiCall(action) {
            const token = await auth.currentUser.getIdToken();
            const res = await fetch('/api/admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ action })
            });
            if(!res.ok) throw new Error("API Error");
            return await res.json();
        }

        async function loadDashboard() {
            try {
                const data = await apiCall('getStats');
                // Since counts are expensive, we might get estimated or hardcoded logic from backend, 
                // or the backend logic below iterates recent to count. 
                // For this demo, let's assume backend sends numbers.
                document.getElementById('stat-users').textContent = data.userCount || '-';
                document.getElementById('stat-pro').textContent = data.proCount || '-';
                document.getElementById('stat-bios').textContent = data.bioCount || '-';

                // Logs
                const logsList = document.getElementById('logs-list');
                logsList.innerHTML = '';
                if(data.logs && data.logs.length) {
                    data.logs.forEach(log => {
                        const div = document.createElement('div');
                        div.className = 'p-4 text-xs';
                        div.innerHTML = `<span class="font-bold text-red-500 uppercase">${log.reason || 'Error'}</span> <span class="text-gray-400 mx-2">|</span> <span class="text-gray-600 dark:text-gray-300 font-mono">${log.id}</span>`;
                        logsList.appendChild(div);
                    });
                } else {
                    logsList.innerHTML = '<div class="p-4 text-center text-sm text-gray-500">No recent system alerts.</div>';
                }
            } catch(e) { console.error(e); }
        }

        async function loadUsers() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center">Loading...</td></tr>';
            try {
                const data = await apiCall('getUsers');
                tbody.innerHTML = '';
                if(!data.users || !data.users.length) {
                     tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-500">No users found.</td></tr>';
                     return;
                }
                
                data.users.forEach(u => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50 dark:hover:bg-[#2c2d2e] transition-colors';
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">${u.email || 'Anonymous'}</td>
                        <td class="px-6 py-4">
                            ${u.isPro ? '<span class="px-2 py-1 text-xs font-bold bg-amber-100 text-amber-700 rounded-full">PRO</span>' : '<span class="px-2 py-1 text-xs font-bold bg-gray-100 text-gray-600 rounded-full">FREE</span>'}
                        </td>
                        <td class="px-6 py-4 font-mono text-xs text-gray-500">${u.uid}</td>
                        <td class="px-6 py-4 text-gray-500 text-xs">${u.lastLogin ? new Date(u.lastLogin).toLocaleDateString() : '-'}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch(e) { 
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-red-500">Failed to load users.</td></tr>';
            }
        }

        async function loadBios() {
            const container = document.getElementById('bios-feed');
            container.innerHTML = '<div class="col-span-2 text-center p-10">Loading...</div>';
            try {
                const data = await apiCall('getRecentBios');
                container.innerHTML = '';
                if(!data.bios || !data.bios.length) {
                    container.innerHTML = '<div class="col-span-2 text-center p-10 text-gray-500">No recent bios.</div>';
                    return;
                }
                
                data.bios.forEach(bio => {
                    const div = document.createElement('div');
                    div.className = 'bg-white dark:bg-[#1e1f20] p-4 rounded-xl border border-gray-200 dark:border-gray-800 shadow-sm';
                    div.innerHTML = `
                        <div class="mb-2 flex items-center justify-between">
                            <span class="text-[10px] font-bold uppercase text-gray-400">${bio.platform}</span>
                            <span class="text-[10px] text-gray-500">${new Date(bio.timestamp).toLocaleDateString()}</span>
                        </div>
                        <div class="text-sm text-gray-800 dark:text-gray-200 mb-2">${bio.bio}</div>
                        <div class="text-xs text-gray-400">By User: <span class="font-mono">${bio.userId.substring(0,8)}...</span></div>
                    `;
                    container.appendChild(div);
                });
            } catch(e) {
                 console.error(e);
                 container.innerHTML = '<div class="col-span-2 text-center p-10 text-red-500">Failed.</div>';
            }
        }

        document.getElementById('refresh-logs').onclick = loadDashboard;
        document.getElementById('refresh-users').onclick = loadUsers;
        document.getElementById('refresh-bios').onclick = loadBios;

    </script>
</body>
</html>
